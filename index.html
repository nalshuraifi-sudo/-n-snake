<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>N-Snake v3.2 â€“ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±Ø©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            min-height: 100vh;
            background: radial-gradient(circle at top, #1b2a49, #050816);
            color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            direction: rtl;
        }

        .container {
            width: 100%;
            max-width: 640px;
            background: rgba(10, 16, 35, 0.95);
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        header h1 {
            font-size: 1.4rem;
            color: #facc15;
        }

        .logo-n {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 2px solid #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #22c55e;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.7);
        }

        .subtitle {
            font-size: 0.78rem;
            color: #9ca3af;
            margin-bottom: 10px;
        }

        .top-row {
            display: grid;
            grid-template-columns: 2.2fr 1.8fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .card {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid rgba(51, 65, 85, 0.9);
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 6px;
            margin-bottom: 6px;
        }

        .score-item span.label {
            display: block;
            font-size: 0.7rem;
            color: #9ca3af;
        }

        .score-item span.value {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 2px;
        }

        #score {
            color: #22c55e;
        }
        #high-score {
            color: #f97316;
        }
        #level {
            color: #38bdf8;
        }

        .rank-text {
            font-size: 0.78rem;
            color: #e5e7eb;
            margin-top: 4px;
        }

        select, button {
            font-family: inherit;
        }

        #speed-select {
            width: 100%;
            margin-top: 4px;
            padding: 4px;
            border-radius: 8px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.78rem;
        }

        .player-info-title {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .player-line {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .player-name {
            color: #22c55e;
            font-weight: 600;
        }

        .leaderboard-title {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .leaderboard-list {
            list-style: none;
            max-height: 110px;
            overflow-y: auto;
            font-size: 0.78rem;
        }

        .leaderboard-list li {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px dashed rgba(55, 65, 81, 0.7);
        }

        .leaderboard-rank {
            color: #facc15;
            margin-inline-end: 4px;
        }

        .leaderboard-score {
            color: #f97316;
            margin-inline-start: 4px;
        }

        .game-shell {
            margin-top: 10px;
            display: grid;
            grid-template-columns: minmax(0, 3fr);
            gap: 10px;
        }

        .game-area {
            position: relative;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid #22c55e;
            box-shadow: 0 14px 30px rgba(15, 23, 42, 0.85);
            background: #020617;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            background: #020617;
        }

        .overlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
            backdrop-filter: blur(6px);
        }

        .overlay.visible {
            display: flex;
        }

        .overlay-card {
            background: rgba(15, 23, 42, 0.97);
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(55, 65, 81, 0.85);
            max-width: 90%;
        }

        .overlay-card h2 {
            font-size: 1.1rem;
            margin-bottom: 6px;
            color: #f97316;
        }

        .overlay-card p {
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: #e5e7eb;
        }

        .overlay-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 2px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #0f172a;
            font-weight: 600;
        }

        .btn.secondary {
            background: #020617;
            color: #e5e7eb;
            border: 1px solid #4b5563;
        }

        .celebration-overlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .celebration-overlay.visible {
            display: flex;
        }

        .celebration-bubble {
            background: rgba(8, 47, 73, 0.96);
            border-radius: 999px;
            padding: 8px 14px;
            border: 1px solid rgba(56, 189, 248, 0.9);
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #f9fafb;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.6);
            animation: pop 0.7s ease-out;
        }

        @keyframes pop {
            0% { transform: scale(0.3); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .explosion-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #f97316;
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.9);
            pointer-events: none;
            animation: explode 0.4s ease-out forwards;
        }

        @keyframes explode {
            from { transform: translate(0,0) scale(0.7); opacity: 1; }
            to { transform: translate(var(--dx), var(--dy)) scale(0.4); opacity: 0; }
        }

        .controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .buttons-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: space-between;
        }

        .btn-small {
            flex: 1;
            min-width: 90px;
            border-radius: 999px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.75rem;
            padding: 6px 10px;
            cursor: pointer;
        }

        .btn-small.primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #0f172a;
            border: none;
            font-weight: 600;
        }

        .dpad-wrapper {
            margin-top: 6px;
            display: flex;
            justify-content: center;
        }

        .dpad {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            grid-template-rows: repeat(3, 50px);
            gap: 4px;
        }

        .dpad button {
            border-radius: 14px;
            border: 1px solid rgba(75, 85, 99, 0.9);
            background: radial-gradient(circle at top, #0f172a, #020617);
            color: #e5e7eb;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.08s;
        }

        .dpad button:active {
            transform: scale(0.9);
            background: #1d283a;
        }

        .dpad-empty {
            pointer-events: none;
            background: transparent !important;
            border: none !important;
        }

        footer {
            margin-top: 10px;
            text-align: center;
            font-size: 0.7rem;
            color: #9ca3af;
        }

        footer strong {
            color: #22c55e;
        }

        .player-setup-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(3, 7, 18, 0.98));
            z-index: 40;
        }

        .player-setup-card {
            background: rgba(15, 23, 42, 1);
            border-radius: 16px;
            padding: 16px;
            max-width: 360px;
            width: 92%;
            border: 1px solid rgba(51, 65, 85, 0.9);
            text-align: center;
        }

        .player-setup-card h2 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #facc15;
        }

        .player-setup-card p {
            font-size: 0.8rem;
            margin-bottom: 10px;
            color: #e5e7eb;
        }

        .player-setup-card input {
            width: 100%;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.8rem;
            margin-bottom: 8px;
            text-align: center;
        }

        .player-setup-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .combo-toast {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(234, 88, 12, 0.96);
            color: #111827;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.75rem;
            box-shadow: 0 0 14px rgba(234, 88, 12, 0.7);
        }

        @media (max-width: 640px) {
            .top-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="player-setup-overlay" id="player-setup">
    <div class="player-setup-card">
        <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ N-Snake</h2>
        <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ ÙˆØ­ÙØ¸ Ø£ÙØ¶Ù„ Ù†ØªØ§Ø¦Ø¬ÙƒØŒ Ø£Ùˆ Ø§Ù„Ø¹Ø¨ ÙƒØ¶ÙŠÙ.</p>
        <input type="text" id="player-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" maxlength="18" />
        <div class="player-setup-actions">
            <button class="btn" id="player-start-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
            <button class="btn secondary" id="player-guest-btn">Ø§Ù„Ø¹Ø¨ ÙƒØ¶ÙŠÙ</button>
        </div>
    </div>
</div>

<div class="container">
    <header>
        <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† â€“ N-Snake v3.2</h1>
        <div class="logo-n">N</div>
    </header>
    <div class="subtitle">Ø¥ØµØ¯Ø§Ø± Ù…Ø·ÙˆÙ‘Ø± Ù…Ø¹ Ù†Ø¸Ø§Ù… Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ Ù„ÙˆØ­Ø© Ù…ØªØµØ¯Ø±ÙŠÙ†ØŒ ÙˆØ³Ø±Ø¹Ø§Øª Ù…Ø±ÙŠØ­Ø© Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†.</div>

    <div class="top-row">
        <div class="card">
            <div class="score-grid">
                <div class="score-item">
                    <span class="label">Ø§Ù„Ù†Ù‚Ø§Ø·</span>
                    <span class="value" id="score">0</span>
                </div>
                <div class="score-item">
                    <span class="label">Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©</span>
                    <span class="value" id="high-score">0</span>
                </div>
                <div class="score-item">
                    <span class="label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span>
                    <span class="value" id="level">1</span>
                </div>
            </div>
            <div class="rank-text" id="rank-text">Ø§Ù„Ù„Ù‚Ø¨: Ù…Ø¨ØªØ¯Ø¦</div>
            <div style="margin-top:6px;">
                <span class="label" style="font-size:0.72rem;">Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
                <select id="speed-select">
                    <option value="260" selected>Ø¨Ø·ÙŠØ¦Ø© Ø¬Ø¯Ù‹Ø§ (Ù…Ø¨ØªØ¯Ø¦)</option>
                    <option value="210">Ø¨Ø·ÙŠØ¦Ø©</option>
                    <option value="160">Ù…ØªÙˆØ³Ø·Ø©</option>
                    <option value="120">Ø³Ø±ÙŠØ¹Ø©</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="player-info-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div class="player-line">Ø§Ù„Ø§Ø³Ù…: <span class="player-name" id="player-name-label">ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±</span></div>
            <div class="player-line">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù„Ùƒ: <span id="player-best-label">0</span></div>
            <div class="player-line">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª: <span id="player-games-label">0</span></div>
            <div class="leaderboard-title" style="margin-top:6px;">Ø£ÙØ¶Ù„ 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù)</div>
            <ul class="leaderboard-list" id="leaderboard-list"></ul>
        </div>
    </div>

    <div class="game-shell">
        <div class="game-area" id="game-area">
            <canvas id="game-canvas" width="400" height="400"></canvas>

            <div class="overlay" id="game-over-overlay">
                <div class="overlay-card">
                    <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø© ğŸ’¥</h2>
                    <p id="game-over-message"></p>
                    <p>Ù†ØªÙŠØ¬ØªÙƒ: <span id="final-score">0</span> â€“ Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ù„Ùƒ: <span id="final-best-score">0</span></p>
                    <div class="overlay-actions">
                        <button class="btn" id="restart-from-start-btn">Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</button>
                        <button class="btn secondary" id="continue-btn">Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø®ÙŠØ±</button>
                    </div>
                </div>
            </div>

            <div class="celebration-overlay" id="celebration-overlay">
                <div class="celebration-bubble" id="celebration-text">
                    ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!
                </div>
            </div>

            <div id="combo-toast" class="combo-toast" style="display:none;">COMBO x2! ğŸ”¥</div>
        </div>
    </div>

    <div class="controls">
        <div class="buttons-row">
            <button class="btn-small primary" id="pause-btn">Ø¥ÙŠÙ‚Ø§Ù / Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
            <button class="btn-small" id="share-btn">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
            <button class="btn-small" id="change-player-btn">ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ø§Ø¹Ø¨</button>
        </div>
        <div class="dpad-wrapper">
            <div class="dpad">
                <button class="dpad-empty"></button>
                <button id="up-btn">â†‘</button>
                <button class="dpad-empty"></button>

                <button id="left-btn">â†</button>
                <button class="dpad-empty"></button>
                <button id="right-btn">â†’</button>

                <button class="dpad-empty"></button>
                <button id="down-btn">â†“</button>
                <button class="dpad-empty"></button>
            </div>
        </div>
    </div>

    <footer>
        ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ØªÙƒØ±ÙŠÙ…Ù‹Ø§ Ù„Ù„Ù…Ø¨Ø¯Ø¹ <strong>Ù†Ø¨ÙŠÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ø´Ø±ÙŠÙÙŠ</strong>ØŒ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© ÙˆØ¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø¬ÙˆØ§Ù„.
    </footer>
</div>

<script>
(function() {
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const gameAreaEl = document.getElementById('game-area');

    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('high-score');
    const levelEl = document.getElementById('level');
    const rankTextEl = document.getElementById('rank-text');

    const gameOverOverlay = document.getElementById('game-over-overlay');
    const gameOverMessageEl = document.getElementById('game-over-message');
    const finalScoreEl = document.getElementById('final-score');
    const finalBestScoreEl = document.getElementById('final-best-score');
    const restartFromStartBtn = document.getElementById('restart-from-start-btn');
    const continueBtn = document.getElementById('continue-btn');

    const celebrationOverlay = document.getElementById('celebration-overlay');
    const celebrationTextEl = document.getElementById('celebration-text');

    const comboToast = document.getElementById('combo-toast');

    const pauseBtn = document.getElementById('pause-btn');
    const shareBtn = document.getElementById('share-btn');
    const changePlayerBtn = document.getElementById('change-player-btn');
    const speedSelect = document.getElementById('speed-select');

    const upBtn = document.getElementById('up-btn');
    const downBtn = document.getElementById('down-btn');
    const leftBtn = document.getElementById('left-btn');
    const rightBtn = document.getElementById('right-btn');

    const playerSetup = document.getElementById('player-setup');
    const playerNameInput = document.getElementById('player-name-input');
    const playerStartBtn = document.getElementById('player-start-btn');
    const playerGuestBtn = document.getElementById('player-guest-btn');

    const playerNameLabel = document.getElementById('player-name-label');
    const playerBestLabel = document.getElementById('player-best-label');
    const playerGamesLabel = document.getElementById('player-games-label');
    const leaderboardList = document.getElementById('leaderboard-list');

    const GRID_SIZE = 20;
    const COLS = canvas.width / GRID_SIZE;
    const ROWS = canvas.height / GRID_SIZE;

    let baseSpeed = parseInt(speedSelect.value, 10);
    let currentSpeed = baseSpeed;
    let loopId = null;

    let snake = [];
    let direction = 'right';
    let nextDirection = 'right';

    let food = null;
    let score = 0;
    let level = 1;
    let isPaused = false;
    let isGameOver = false;
    let lastEatTime = 0;
    let comboCount = 0;
    let comboTimeoutId = null;

    let eatEffectUntil = 0;

    let currentPlayerName = 'Ø¶ÙŠÙ';
    let players = [];
    let currentPlayerRecord = null;

    let canContinue = false;
    let continueLevel = 1;

    const lossMessagesTemplates = [
        "Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù…ØªØ§Ø²Ø© ÙŠØ§ [name] ğŸ’ª Ø§Ø¶ØºØ· Ø¥Ø¹Ø§Ø¯Ø© ÙˆÙˆØ±Ù‘ÙŠÙ†Ø§ Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.",
        "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©â€¦ Ù„ÙƒÙ† Ù…Ùˆ Ù†Ù‡Ø§ÙŠØªÙƒ ğŸ‘Œ Ø¬Ø±Ø¨ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ÙˆØ­Ù‚Ù‘Ù‚ Ø±Ù‚Ù… Ø£Ù‚ÙˆÙ‰!",
        "ÙƒÙ„ Ù„Ø§Ø¹Ø¨ Ù…Ø­ØªØ±Ù Ø®Ø³Ø± Ø¢Ù„Ø§Ù Ø§Ù„Ù…Ø±Ø§Øª Ù‚Ø¨Ù„ Ù…Ø§ ÙŠØµÙŠØ± Ø¨Ø·Ù„â€¦ Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© ğŸ˜„",
        "ÙˆÙ„Ø§ ÙŠÙ‡Ù…Ù‘Ùƒ ÙŠØ§ [name]â€¦ Ø£Ù‡Ù… Ø´ÙŠØ¡ Ø¥Ù†Ùƒ ØªØ­Ø§ÙˆÙ„. Ø§Ø¶ØºØ· Ø¥Ø¹Ø§Ø¯Ø© ÙˆØ®Ù„ÙŠÙ†Ø§ Ù†ÙƒÙ…Ù‘Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ!"
    ];

    function rankForScore(sc) {
        if (sc >= 300) return 'Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©';
        if (sc >= 200) return 'Ø®Ø¨ÙŠØ±';
        if (sc >= 100) return 'Ù…Ø­ØªØ±Ù';
        if (sc >= 50) return 'Ù…ØªÙ‚Ø¯Ù‘Ù…';
        return 'Ù…Ø¨ØªØ¯Ø¦';
    }

    function bgColorForLevel(lv) {
        if (lv >= 4) return '#1f1435';
        if (lv === 3) return '#1f2937';
        if (lv === 2) return '#052e16';
        return '#020617';
    }

    function loadPlayers() {
        try {
            const raw = localStorage.getItem('nSnakePlayers');
            players = raw ? JSON.parse(raw) : [];
        } catch (e) {
            players = [];
        }
    }

    function savePlayers() {
        try {
            localStorage.setItem('nSnakePlayers', JSON.stringify(players));
        } catch (e) {}
    }

    function findOrCreatePlayer(name) {
        let p = players.find(pl => pl.name === name);
        if (!p) {
            p = {
                name,
                highScore: 0,
                lastScore: 0,
                games: 0,
                lastPlayed: null
            };
            players.push(p);
        }
        return p;
    }

    function updatePlayerUI() {
        if (!currentPlayerRecord) return;
        playerNameLabel.textContent = currentPlayerRecord.name;
        playerBestLabel.textContent = currentPlayerRecord.highScore;
        playerGamesLabel.textContent = currentPlayerRecord.games;
    }

    function updateLeaderboard() {
        const sorted = [...players].sort((a, b) => b.highScore - a.highScore).slice(0, 5);
        leaderboardList.innerHTML = '';
        sorted.forEach((p, idx) => {
            const li = document.createElement('li');
            const leftSpan = document.createElement('span');
            const rightSpan = document.createElement('span');
            leftSpan.innerHTML = '<span class="leaderboard-rank">#' + (idx+1) + '</span>' + p.name;
            rightSpan.className = 'leaderboard-score';
            rightSpan.textContent = p.highScore;
            li.appendChild(leftSpan);
            li.appendChild(rightSpan);
            leaderboardList.appendChild(li);
        });
    }

    function initGame(startLevel = 1) {
        snake = [
            {x: 5, y: 10},
            {x: 4, y: 10},
            {x: 3, y: 10}
        ];
        direction = 'right';
        nextDirection = 'right';
        score = 0;
        level = startLevel;
        isPaused = false;
        isGameOver = false;
        lastEatTime = 0;
        comboCount = 0;
        eatEffectUntil = 0;

        scoreEl.textContent = '0';
        levelEl.textContent = level;
        rankTextEl.textContent = 'Ø§Ù„Ù„Ù‚Ø¨: ' + rankForScore(0);
        gameOverOverlay.classList.remove('visible');
        hideCelebration();
        hideComboToast();
        generateFood();
        updateSpeed();
        clearInterval(loopId);
        loopId = setInterval(gameLoop, currentSpeed);
        draw();
    }

    function updateSpeed() {
        baseSpeed = parseInt(speedSelect.value, 10);
        let lv = level;
        let speed;
        // Ø£ÙˆÙ„ 3 Ù…Ø³ØªÙˆÙŠØ§Øª Ø£Ø¨Ø·Ø£ Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­
        if (lv <= 1) speed = baseSpeed + 90;          // Ø£Ø¨Ø·Ø£ Ø´ÙŠØ¡
        else if (lv === 2) speed = baseSpeed + 60;
        else if (lv === 3) speed = baseSpeed + 30;
        else {
            // Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4 ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ³Ø§Ø±Ø¹ ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§
            speed = baseSpeed - (lv - 4) * 10;
        }
        currentSpeed = Math.max(90, speed);
        if (!isGameOver && !isPaused) {
            clearInterval(loopId);
            loopId = setInterval(gameLoop, currentSpeed);
        }
    }

    function setLevelByScore() {
        const newLevel = Math.floor(score / 30) + 1;
        if (newLevel !== level) {
            level = newLevel;
            levelEl.textContent = level;
            flashLevelUp();
            updateSpeed();
        }
    }

    function flashLevelUp() {
        const originalBorder = gameAreaEl.style.borderColor;
        gameAreaEl.style.borderColor = '#f97316';
        setTimeout(() => {
            gameAreaEl.style.borderColor = '#22c55e';
        }, 300);
        playBeep(660, 120);
    }

    function generateFood() {
        let valid = false;
        while (!valid) {
            const fx = Math.floor(Math.random() * COLS);
            const fy = Math.floor(Math.random() * ROWS);
            valid = !snake.some(seg => seg.x === fx && seg.y === fy);
            if (valid) {
                food = {x: fx, y: fy};
            }
        }
    }

    function gameLoop() {
        if (isPaused || isGameOver) return;
        direction = nextDirection;
        const head = {...snake[0]};
        if (direction === 'up') head.y--;
        else if (direction === 'down') head.y++;
        else if (direction === 'left') head.x--;
        else if (direction === 'right') head.x++;

        const hitWall = head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS;
        if (hitWall) {
            onGameOver(head);
            return;
        }

        for (let i = 0; i < snake.length; i++) {
            if (head.x === snake[i].x && head.y === snake[i].y) {
                onGameOver(head);
                return;
            }
        }

        snake.unshift(head);

        if (head.x === food.x && head.y === food.y) {
            handleFoodEaten();
        } else {
            snake.pop();
        }

        draw();
    }

    function handleFoodEaten() {
        const now = performance.now();
        if (now - lastEatTime < 5000) {
            comboCount++;
        } else {
            comboCount = 1;
        }
        lastEatTime = now;

        let gained = 10;
        if (comboCount >= 3) {
            gained *= 2;
            showComboToast();
        }

        score += gained;
        scoreEl.textContent = score;
        setLevelByScore();
        rankTextEl.textContent = 'Ø§Ù„Ù„Ù‚Ø¨: ' + rankForScore(score);
        generateFood();
        playBeep(440, 80);

        // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø¶Øº Ù„Ù…Ø¯Ø© Ù‚ØµÙŠØ±Ø©
        eatEffectUntil = performance.now() + 400;

        if (currentPlayerRecord && score > currentPlayerRecord.highScore) {
            currentPlayerRecord.highScore = score;
            highScoreEl.textContent = score;
            triggerCelebration('highscore');
            speakCongrats();
        } else {
            if (!currentPlayerRecord || score > parseInt(highScoreEl.textContent || '0', 10)) {
                highScoreEl.textContent = score;
            }
        }

        if (score >= 50 && score - gained < 50) {
            triggerCelebration('milestone');
        }
    }

    function drawBackground() {
        ctx.fillStyle = bgColorForLevel(level);
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.strokeStyle = 'rgba(148,163,184,0.12)';
        ctx.lineWidth = 1;
        for (let x = 0; x <= canvas.width; x += GRID_SIZE) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }
        for (let y = 0; y <= canvas.height; y += GRID_SIZE) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
    }

    function drawFood() {
        if (!food) return;
        const cx = food.x * GRID_SIZE + GRID_SIZE / 2;
        const cy = food.y * GRID_SIZE + GRID_SIZE / 2;
        const size = GRID_SIZE * 0.8;
        const h = size * 0.9;

        ctx.save();
        ctx.translate(cx, cy);
        const t = performance.now() / 400;
        const pulse = 1 + 0.08 * Math.sin(t * 2 * Math.PI);
        ctx.scale(pulse, pulse);

        // Ù‚Ø·Ø¹Ø© Ø¬Ø¨Ù† Ù…Ø«Ù„Ø«Ø©
        ctx.beginPath();
        ctx.moveTo(0, -h / 2);
        ctx.lineTo(-size / 2, h / 2);
        ctx.lineTo(size / 2, h / 2);
        ctx.closePath();
        ctx.fillStyle = '#facc15';
        ctx.fill();
        ctx.strokeStyle = '#f97316';
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.fillStyle = '#7c2d12';
        ctx.beginPath();
        ctx.arc(-size * 0.15, 0, 2, 0, Math.PI * 2);
        ctx.arc(0, h * 0.1, 2, 0, Math.PI * 2);
        ctx.arc(size * 0.12, -h * 0.1, 2, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }

    function drawSnake() {
        const chewing = performance.now() < eatEffectUntil;

        for (let i = snake.length - 1; i >= 0; i--) {
            const seg = snake[i];
            const x = seg.x * GRID_SIZE;
            const y = seg.y * GRID_SIZE;
            const isHead = (i === 0);

            let alpha = 0.9 - (i / (snake.length * 1.5));
            if (alpha < 0.3) alpha = 0.3;

            if (isHead) {
                const baseColor = score >= 50 ? '#eab308' : '#22c55e';
                const headGradient = ctx.createLinearGradient(x, y, x + GRID_SIZE, y + GRID_SIZE);
                headGradient.addColorStop(0, baseColor);
                headGradient.addColorStop(1, '#16a34a');

                ctx.fillStyle = headGradient;
                ctx.strokeStyle = '#0f172a';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.roundRect(x + 1, y + 1, GRID_SIZE - 2, GRID_SIZE - 2, 7);
                ctx.fill();
                ctx.stroke();

                // Ø¹ÙŠÙˆÙ†
                const eyeRadius = 2.4;
                ctx.fillStyle = '#0f172a';
                if (direction === 'right') {
                    ctx.beginPath();
                    ctx.arc(x + GRID_SIZE - 6, y + 8, eyeRadius, 0, Math.PI * 2);
                    ctx.arc(x + GRID_SIZE - 6, y + GRID_SIZE - 8, eyeRadius, 0, Math.PI * 2);
                    ctx.fill();
                } else if (direction === 'left') {
                    ctx.beginPath();
                    ctx.arc(x + 6, y + 8, eyeRadius, 0, Math.PI * 2);
                    ctx.arc(x + 6, y + GRID_SIZE - 8, eyeRadius, 0, Math.PI * 2);
                    ctx.fill();
                } else if (direction === 'up') {
                    ctx.beginPath();
                    ctx.arc(x + 8, y + 6, eyeRadius, 0, Math.PI * 2);
                    ctx.arc(x + GRID_SIZE - 8, y + 6, eyeRadius, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.beginPath();
                    ctx.arc(x + 8, y + GRID_SIZE - 6, eyeRadius, 0, Math.PI * 2);
                    ctx.arc(x + GRID_SIZE - 8, y + GRID_SIZE - 6, eyeRadius, 0, Math.PI * 2);
                    ctx.fill();
                }

                // ÙÙ… / Ù…Ø¶Øº
                if (chewing) {
                    ctx.fillStyle = '#0f172a';
                    ctx.beginPath();
                    if (direction === 'right') {
                        ctx.fillRect(x + GRID_SIZE - 4, y + 8, 3, GRID_SIZE - 16);
                    } else if (direction === 'left') {
                        ctx.fillRect(x + 1, y + 8, 3, GRID_SIZE - 16);
                    } else if (direction === 'up') {
                        ctx.fillRect(x + 8, y + 1, GRID_SIZE - 16, 3);
                    } else if (direction === 'down') {
                        ctx.fillRect(x + 8, y + GRID_SIZE - 4, GRID_SIZE - 16, 3);
                    }
                }
            } else {
                const gradient = ctx.createLinearGradient(x, y, x + GRID_SIZE, y + GRID_SIZE);
                if (score >= 50) {
                    gradient.addColorStop(0, 'rgba(147, 51, 234,' + alpha + ')');
                    gradient.addColorStop(1, 'rgba(236, 72, 153,' + alpha + ')');
                } else {
                    gradient.addColorStop(0, 'rgba(34,197,94,' + alpha + ')');
                    gradient.addColorStop(1, 'rgba(16,185,129,' + alpha + ')');
                }
                ctx.fillStyle = gradient;
                ctx.strokeStyle = 'rgba(15,23,42,0.9)';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.roundRect(x + 3, y + 3, GRID_SIZE - 6, GRID_SIZE - 6, 4);
                ctx.fill();
                ctx.stroke();
            }
        }
    }

    function drawHintLine() {
        if (!snake.length || !food) return;
        const head = snake[0];
        const hx = head.x * GRID_SIZE + GRID_SIZE / 2;
        const hy = head.y * GRID_SIZE + GRID_SIZE / 2;
        const fx = food.x * GRID_SIZE + GRID_SIZE / 2;
        const fy = food.y * GRID_SIZE + GRID_SIZE / 2;

        if (score > 80) return;

        ctx.save();
        ctx.strokeStyle = 'rgba(59,130,246,0.4)';
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(hx, hy);
        ctx.lineTo(fx, fy);
        ctx.stroke();
        ctx.restore();
    }

    function draw() {
        drawBackground();
        drawHintLine();
        drawFood();
        drawSnake();
    }

    function spawnExplosion(head) {
        const rect = gameAreaEl.getBoundingClientRect();
        const cx = head.x * GRID_SIZE + GRID_SIZE / 2;
        const cy = head.y * GRID_SIZE + GRID_SIZE / 2;
        const offsets = [
            {dx: -20, dy: -10},
            {dx: 18, dy: -8},
            {dx: -15, dy: 14},
            {dx: 16, dy: 16},
            {dx: 0, dy: -22}
        ];
        offsets.forEach(o => {
            const dot = document.createElement('div');
            dot.className = 'explosion-dot';
            dot.style.left = (cx + o.dx) + 'px';
            dot.style.top = (cy + o.dy) + 'px';
            dot.style.setProperty('--dx', o.dx + 'px');
            dot.style.setProperty('--dy', o.dy + 'px');
            gameAreaEl.appendChild(dot);
            setTimeout(() => gameAreaEl.removeChild(dot), 400);
        });
    }

    function onGameOver(head) {
        isGameOver = true;
        clearInterval(loopId);
        playBeep(180, 220);
        spawnExplosion(head);

        const now = new Date().toISOString();
        if (currentPlayerRecord) {
            currentPlayerRecord.lastScore = score;
            currentPlayerRecord.games += 1;
            currentPlayerRecord.lastPlayed = now;
            if (score > currentPlayerRecord.highScore) {
                currentPlayerRecord.highScore = score;
            }
        }

        const globalHigh = players.reduce((max, p) => Math.max(max, p.highScore), 0);
        highScoreEl.textContent = globalHigh;

        savePlayers();
        updatePlayerUI();
        updateLeaderboard();

        finalScoreEl.textContent = score;
        finalBestScoreEl.textContent = currentPlayerRecord ? currentPlayerRecord.highScore : score;

        const template = lossMessagesTemplates[Math.floor(Math.random() * lossMessagesTemplates.length)];
        const msg = template.replace('[name]', currentPlayerName);
        gameOverMessageEl.textContent = msg;

        if (score >= 50) {
            canContinue = true;
            continueLevel = level;
            continueBtn.style.display = 'inline-block';
            continueBtn.textContent = 'Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ' + level;
        } else {
            canContinue = false;
            continueBtn.style.display = 'none';
        }

        gameOverOverlay.classList.add('visible');
    }

    function triggerCelebration(type) {
        let text = 'ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!';
        if (type === 'milestone') {
            text = 'ğŸ”¥ ÙˆØµÙ„Øª Ù„Ù€ 50 Ù†Ù‚Ø·Ø© ÙŠØ§ ' + currentPlayerName + '! Ø§Ø³ØªÙ…Ø±!';
        }
        celebrationTextEl.textContent = text;
        celebrationOverlay.classList.add('visible');
        setTimeout(hideCelebration, 1000);
    }

    function hideCelebration() {
        celebrationOverlay.classList.remove('visible');
    }

    function showComboToast() {
        comboToast.style.display = 'block';
        if (comboTimeoutId) clearTimeout(comboTimeoutId);
        comboTimeoutId = setTimeout(hideComboToast, 800);
    }

    function hideComboToast() {
        comboToast.style.display = 'none';
    }

    function playBeep(freq, duration) {
        try {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) return;
            const ctxAudio = new AudioCtx();
            const osc = ctxAudio.createOscillator();
            const gain = ctxAudio.createGain();
            osc.type = 'square';
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(ctxAudio.destination);
            gain.gain.setValueAtTime(0.18, ctxAudio.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctxAudio.currentTime + duration / 1000);
            osc.start();
            osc.stop(ctxAudio.currentTime + duration / 1000 + 0.05);
        } catch (e) {}
    }

    function speakCongrats() {
        if (!('speechSynthesis' in window)) return;
        const text = 'Ù…Ø¨Ø±ÙˆÙƒ ÙŠØ§ ' + currentPlayerName + 'ØŒ Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!';
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'ar-SA';
        utter.rate = 1.02;
        try {
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        } catch (e) {}
    }

    document.addEventListener('keydown', function(e) {
        if (playerSetup.style.display !== 'none') return;

        if (e.key === 'ArrowUp' && direction !== 'down') nextDirection = 'up';
        else if (e.key === 'ArrowDown' && direction !== 'up') nextDirection = 'down';
        else if (e.key === 'ArrowLeft' && direction !== 'right') nextDirection = 'left';
        else if (e.key === 'ArrowRight' && direction !== 'left') nextDirection = 'right';
        else if (e.key === ' ' || e.key === 'p' || e.key === 'P') togglePause();
    });

    upBtn.addEventListener('click', () => { if (direction !== 'down') nextDirection = 'up'; });
    downBtn.addEventListener('click', () => { if (direction !== 'up') nextDirection = 'down'; });
    leftBtn.addEventListener('click', () => { if (direction !== 'right') nextDirection = 'left'; });
    rightBtn.addEventListener('click', () => { if (direction !== 'left') nextDirection = 'right'; });

    function togglePause() {
        if (isGameOver) return;
        isPaused = !isPaused;
        pauseBtn.textContent = isPaused ? 'Ø§Ø³ØªØ¦Ù†Ø§Ù' : 'Ø¥ÙŠÙ‚Ø§Ù / Ø§Ø³ØªØ¦Ù†Ø§Ù';
    }

    pauseBtn.addEventListener('click', togglePause);

    restartFromStartBtn.addEventListener('click', function() {
        gameOverOverlay.classList.remove('visible');
        initGame(1);
    });

    continueBtn.addEventListener('click', function() {
        if (!canContinue) return;
        gameOverOverlay.classList.remove('visible');
        initGame(continueLevel);
    });

    speedSelect.addEventListener('change', function() {
        updateSpeed();
    });

    shareBtn.addEventListener('click', function() {
        const text = 'Ø­Ù‚Ù‚Øª Ù†ØªÙŠØ¬Ø© ' + score + ' ÙÙŠ Ù„Ø¹Ø¨Ø© N-Snake Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±Ø©! Ø¬Ø±Ù‘Ø¨Ù‡Ø§ Ø£Ù†Øª Ø£ÙŠØ¶Ù‹Ø§ ğŸ®ğŸ';
        if (navigator.share) {
            navigator.share({
                title: 'Ù„Ø¹Ø¨Ø© N-Snake',
                text,
                url: window.location.href
            }).catch(() => {});
        } else if (navigator.clipboard) {
            navigator.clipboard.writeText(text + ' ' + window.location.href)
                .then(() => alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.'));
        } else {
            alert(text);
        }
    });

    changePlayerBtn.addEventListener('click', function() {
        playerSetup.style.display = 'flex';
    });

    playerStartBtn.addEventListener('click', function() {
        const name = (playerNameInput.value || '').trim();
        if (!name) {
            alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨ ÙƒØ¶ÙŠÙ.');
            return;
        }
        startForPlayer(name);
        playerSetup.style.display = 'none';
    });

    playerGuestBtn.addEventListener('click', function() {
        startForPlayer('Ø¶ÙŠÙ');
        playerSetup.style.display = 'none';
    });

    function startForPlayer(name) {
        currentPlayerName = name;
        loadPlayers();
        currentPlayerRecord = findOrCreatePlayer(name);
        highScoreEl.textContent = currentPlayerRecord.highScore || 0;
        updatePlayerUI();
        updateLeaderboard();
        initGame(1);
    }

    loadPlayers();
    playerSetup.style.display = 'flex';
    draw();
})();
</script>
</body>
</html>
