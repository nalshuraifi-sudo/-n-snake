<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>N-Snake v4.0 â€“ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ø§Ù„Ù…Ù„ÙƒÙŠØ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1b2a49, #050816);
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      direction: rtl;
    }
    .container {
      width: 100%;
      max-width: 680px;
      background: rgba(10, 16, 35, 0.96);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
      position: relative;
    }
    .logo-snake {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #fef3c7, #eab308, #854d0e);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 18px rgba(250, 204, 21, 0.9);
      position: absolute;
      top: -8px;
    }
    .logo-snake span {
      font-size: 28px;
    }
    header h1 {
      font-size: 1.3rem;
      color: #facc15;
      padding-top: 32px;
      text-align: center;
    }
    .subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 10px;
    }
    .top-row {
      display: grid;
      grid-template-columns: 2.1fr 1.9fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .card {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(51, 65, 85, 0.9);
    }
    .score-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 6px;
    }
    .score-item span.label {
      display: block;
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .score-item span.value {
      font-size: 1.1rem;
      font-weight: 700;
      margin-top: 2px;
    }
    #score { color: #22c55e; }
    #high-score { color: #f97316; }
    #level { color: #38bdf8; }
    .rank-text {
      font-size: 0.78rem;
      color: #e5e7eb;
      margin-top: 4px;
    }
    select, button, input { font-family: inherit; }
    #speed-select {
      width: 100%;
      margin-top: 4px;
      padding: 4px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.78rem;
    }
    .player-info-title {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .player-line {
      font-size: 0.8rem;
      margin-bottom: 2px;
    }
    .player-name {
      color: #22c55e;
      font-weight: 600;
    }
    .leaderboard-title {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 6px;
      margin-bottom: 4px;
    }
    .leaderboard-list {
      list-style: none;
      max-height: 110px;
      overflow-y: auto;
      font-size: 0.78rem;
    }
    .leaderboard-list li {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
      border-bottom: 1px dashed rgba(55, 65, 81, 0.7);
    }
    .leaderboard-rank {
      color: #facc15;
      margin-inline-end: 4px;
    }
    .leaderboard-score {
      color: #f97316;
      margin-inline-start: 4px;
    }
    .game-shell {
      margin-top: 10px;
    }
    .game-area {
      position: relative;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid #22c55e;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.85);
      background: #020617;
    }
    canvas {
      display: block;
      width: 100%;
      height: auto;
      background: #020617;
    }
    .overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      backdrop-filter: blur(6px);
      background: rgba(15, 23, 42, 0.92);
    }
    .overlay.visible { display: flex; }
    .overlay-card {
      background: rgba(15, 23, 42, 1);
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      max-width: 90%;
    }
    .overlay-card h2 {
      font-size: 1.1rem;
      margin-bottom: 6px;
      color: #f97316;
    }
    .overlay-card p {
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #e5e7eb;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 6px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #0f172a;
      font-weight: 600;
    }
    .btn.secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .celebration-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .celebration-overlay.visible { display: flex; }
    .celebration-bubble {
      background: rgba(8, 47, 73, 0.96);
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid rgba(56, 189, 248, 0.9);
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #f9fafb;
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.6);
      animation: pop 0.7s ease-out;
    }
    @keyframes pop {
      0% { transform: scale(0.3); opacity: 0; }
      60% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .controls {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: space-between;
    }
    .btn-small {
      flex: 1;
      min-width: 90px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      padding: 6px 10px;
      cursor: pointer;
    }
    .btn-small.primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #0f172a;
      border: none;
      font-weight: 600;
    }
    .dpad-wrapper {
      margin-top: 6px;
      display: flex;
      justify-content: center;
    }
    .dpad {
      display: grid;
      grid-template-columns: repeat(3, 64px);
      grid-template-rows: repeat(3, 64px);
      gap: 8px;
    }
    .dpad button {
      border-radius: 18px;
      border: 1px solid rgba(75, 85, 99, 0.95);
      background: radial-gradient(circle at top, #0f172a, #020617);
      color: #e5e7eb;
      font-size: 1.4rem;
      cursor: pointer;
      transition: transform 0.08s, background 0.08s;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.9);
    }
    .dpad button:active {
      transform: scale(0.9);
      background: #1f2937;
    }
    .dpad-empty {
      pointer-events: none;
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
    footer {
      margin-top: 10px;
      text-align: center;
      font-size: 0.7rem;
      color: #9ca3af;
    }
    footer strong { color: #22c55e; }
    .player-setup-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(3, 7, 18, 0.98));
      z-index: 40;
    }
    .player-setup-card {
      background: rgba(15, 23, 42, 1);
      border-radius: 16px;
      padding: 16px;
      max-width: 360px;
      width: 92%;
      border: 1px solid rgba(51, 65, 85, 0.9);
      text-align: center;
    }
    .player-setup-card h2 {
      font-size: 1.1rem;
      margin-bottom: 8px;
      color: #facc15;
    }
    .player-setup-card p {
      font-size: 0.8rem;
      margin-bottom: 10px;
      color: #e5e7eb;
    }
    .player-setup-card input {
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      margin-bottom: 8px;
      text-align: center;
    }
    .player-setup-actions {
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    .combo-toast {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(234, 88, 12, 0.96);
      color: #111827;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      box-shadow: 0 0 14px rgba(234, 88, 12, 0.7);
      display: none;
    }
    @media (max-width: 640px) {
      .top-row {
        grid-template-columns: 1fr;
      }
      .dpad {
        grid-template-columns: repeat(3, 60px);
        grid-template-rows: repeat(3, 60px);
      }
    }
  </style>
</head>
<body>

<!-- Ù…Ø¤Ø«Ø±Ø§Øª ØµÙˆØªÙŠØ© Ø¨ØµÙŠØºØ© Base64 -->
<audio id="snd-eat" preload="auto"
  src="data:audio/wav;base64,UklGRnwpAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVgpAAAAAAAI4Q+CF8QeiyW6KzoxYTs1dEJ/dYqMk52cqKisrrS2u77CxsjPxMTGycvFw9nM0sjar5y6uLrDy9TU1tjc4uamqp6jpqStpaGckZ2WkIjUf3qQcHG6kZifcVFNOGwuIiMnQ0lrb6LQ3+fV2OHJxcW8vLm2qaCXjYl9aFdHPzoY8+jj3t/c1dTPzM7Btdmamps0IyO9wd+rrJqGg1Y/OgoI59XJzt/k19W/o6S6trjGydnNzcamoq6srq3Fu7G0tb6xtbnE1NPd2NvW2dbf2ejw5Ofo4uTj4N/Z3NbV1M/MzsvJyL+op6WnhX9UUDQtM+XQ296+s7rAv62wiWV3QlJJSj7/693Sybi0oKGGfVk9MB4Q4NT33+TV19rgrqzE1c+/o6qtq6yxuL20trWys7W8sLq0u7KxtrC1u7C7tLvFy9zf3uDh39rd19nj3+nm5+fh4uDa3dfUx7u0rqiprnqeip+goJmAgH1xW1lNPix77tzN0da7rq2xt8TExMGyv7rEz6S5qbGvub2608C9vd3g3d/p4+7h5+zb2NbTw8W9vbKtlIGDa09PQiXj39Hc19XgrKXC0cK8q6OlpKGtpKWQm4+SiouJhoCAf3Zycm9va2tmZU1JUElOQxwi7t7JydTSzrGddmd0g4dvaWSJU1IvJx4M497TyM+9sLOqtqi/v7/H0Mq9t7bByMq8u7q8uLq2ubnAyd3o3N7o5+7j5+re29vUycKzsqmehpZfWlNNQz5eVUzBi5/EyeLOvK2qb621uLjM09vd3tXJ1ci8v7+wtLS4vLu8wsy/vsPHw8bFxcjDzbe1tLCljYqFdlpOJClSQD0tGhLk2sjgsq7Aubacu7PCycHTz9TeudvZ6uzl6u7n7Ovc3NjTysrDt7GwhXdiXVpEMSAwUkdcZ0E9Un5eYEZ4Y5bAuczk6eesp6edpZ2ZpJ+doaOXnKKroqWiobnI4uw=">
</audio>

<audio id="snd-gameover" preload="auto"
  src="data:audio/wav;base64,UklGRkZWAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YSJWAAAAAAECAgQCBgAI/Qn3C+0N7hD5FfwW/hv8IP8l/zT/Nf86/z3/Qf9M/2H/a/97/4P/jf+e/6P/r/+1/8H/zP/Z/9//5P/u//H/9f/6//z//v/8//b/8f/x//L/7//v/+7/7f/t/+n/5P/a/8j/vf+l/4z/e/9h/1D/Tv89/zn/Nv8y/yf/If8X/wsH7wrxCfwI+gf0BvH+9v3m/dD8vftz+1/6X/lf+WD5VPlQ+Ur4U/h++Hj3MfKw8bzwtPCr75bvlN+FL4T/hE+EP3Avcp9yz3Jfcl9yb1JvSq9Zb3nfgD+Yf6/fxF/UX8fftk/Bb9R/6O/8f/6f9b/xH+gvx5+3z2IPcx7yzpF+Pn3jfdg92x3b3gff59731vfG99/7ofxZ/fv9D/5H/3z+sfwT/TL8bPx3/Fz+Nv68/iT+e/0V/YD7OPrH9/f3Jffd++T72/vZ+8L73Pze/N78Uvyv/EH9pv5b/mP9yv6d/qH+q/7F/tv+5v7//gX/Nf9q/4X/tP/O/9H/2P/l//H//P78/fL9zf3H/cP9v/3P/dz94P3m/er97v3w/e/97/3v/ej95v3d/dL9w/29/bP9sP2g/ZP9ef1i/UD9Mf0j/RP9Af3w/ej95/3o/en95/3z/ff99v3+/QX+BP4I/hT+Gf4h/ij+Lf45/kL+SP5e/mH+aP5u/nH+eP6B/oX+iP6M/o3+j/6Y/pz+qP6u/sP+1/7t/v7/BP8M/xH/GP8f/yP/J/8w/zv/Qv9M/1z/Yv9s/3H/hP+M/5X/oP+t/7L/uP/A/8b/0P/a/+L/5//u//H/9P/3//v/+P/2//H/7v/w/+z/4//f/8v/p/+P/1P/G/7X/tf+4/77/xv/I/9D/1P/k/+3/9P/6//z/+P/0//H/7v/x//H/7//o/+L/2v/U/8v/wP+1/7T/rP+q/6D/mv+W/4//hP+E/3v/bv9k/1P/RP88/zn/M/8o/yH/Bv8H/xT/If8v/zX/Q/9M/1n/Zf9u/3v/gP+L/5b/m/+g/6X/rf+z/7v/wf/M/9P/2P/b/93/5f/q/+z/9P/3//n/+v/8//z/+//4//X/9P/0//T/8v/w/+3/5//a/8//wP+4/6//qf+j/4z/eP9j/1//T/84/zL/I/8e/xH/Cv8B/wX/DP8R/xv/KP86/0//Xv9u/4b/lv+g/7H/xP/I/8j/v/+t/7L/u//B/8X/z//Q/9H/zv/H/7//rf+f/43/dP9a/1P/Q/81/zH/Iv8W/w//Bf8B/+7+6P7R/sP+xv7f/gL/Mf9u/5X/sv/Y/+L/8v/+/v7y/ub96P3j/d392v3K/cD9qv2a/Yv9d/1y/WL9TP1H/Tr9N/0z/Sv9H/0g/S/9R/1z/bf+D/5L/qP+1/8b/1v/o//T/+v/9//v/9P/r/87/t/+p/5z/j/+K/4L/eP9v/27/ZP9Y/07/O/8o/xT/A//z/uX+yv7E/sD+vP6f/oP+af5o/mL+XP5R/kP+N/4l/hP+Ev4B/gH+Af4F/g/+Fv4n/jP+g/7L/1f/z//X/+P/3//L/6v/U/7z/q/+R/2z/Rf8y/x//Df/5/tP+b/8H/5/+Mf5x/UD+ZP2Q/af9xf3P/dj96P3x/fv9Bf4P/hf+KP4z/j7+Tv5f/nf+lP+y/7v/0f/h//P/AwA=">
</audio>

<div class="player-setup-overlay" id="player-setup">
  <div class="player-setup-card">
    <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ N-Snake v4.0</h2>
    <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ ÙˆØ­ÙØ¸ Ø£ÙØ¶Ù„ Ù†ØªØ§Ø¦Ø¬ÙƒØŒ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨ ÙƒØ¶ÙŠÙ. Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±.</p>
    <input list="players-list" type="text" id="player-name-input"
           placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" maxlength="18" />
    <datalist id="players-list"></datalist>
    <div class="player-setup-actions">
      <button class="btn" id="player-start-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
      <button class="btn secondary" id="player-guest-btn">Ø§Ù„Ø¹Ø¨ ÙƒØ¶ÙŠÙ</button>
    </div>
  </div>
</div>

<div class="container">
  <header>
    <div class="logo-snake"><span>ğŸ</span></div>
    <h1>N-Snake v4.0 â€“ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h1>
  </header>
  <div class="subtitle">
    Ù†Ø³Ø®Ø© Ù…Ø·ÙˆÙ‘Ø±Ø© Ù…Ø®ØµÙ‘ØµØ© Ù„Ù€ <strong>Ù†Ø¨ÙŠÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ø´Ø±ÙŠÙÙŠ</strong> â€“ Ù†Ø¸Ø§Ù… Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ Ù„ÙˆØ­Ø© Ø´Ø±ÙØŒ ÙˆÙ…Ø³ØªÙˆÙŠØ§Øª Ø­ØªÙ‰ 10,000 Ù†Ù‚Ø·Ø©.
  </div>

  <div class="top-row">
    <div class="card">
      <div class="score-grid">
        <div class="score-item">
          <span class="label">Ø§Ù„Ù†Ù‚Ø§Ø·</span>
          <span class="value" id="score">0</span>
        </div>
        <div class="score-item">
          <span class="label">Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©</span>
          <span class="value" id="high-score">0</span>
        </div>
        <div class="score-item">
          <span class="label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span>
          <span class="value" id="level">1</span>
        </div>
      </div>
      <div class="rank-text" id="rank-text">Ø§Ù„Ù„Ù‚Ø¨: Ù…Ø¨ØªØ¯Ø¦</div>
      <div style="margin-top:6px;">
        <span class="label" style="font-size:0.72rem;">Ø§Ù„Ø³Ø±Ø¹Ø©</span>
        <select id="speed-select">
          <option value="260" selected>Ø¨Ø·ÙŠØ¦Ø© Ø¬Ø¯Ù‹Ø§ (Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†)</option>
          <option value="210">Ø¨Ø·ÙŠØ¦Ø©</option>
          <option value="165">Ù…ØªÙˆØ³Ø·Ø©</option>
          <option value="125">Ø³Ø±ÙŠØ¹Ø©</option>
          <option value="90">Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ù‹Ø§</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div class="player-info-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
      <div class="player-line">Ø§Ù„Ø§Ø³Ù…: <span class="player-name" id="player-name-label">ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±</span></div>
      <div class="player-line">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù„Ùƒ: <span id="player-best-label">0</span></div>
      <div class="player-line">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª: <span id="player-games-label">0</span></div>
      <div class="leaderboard-title">Ø£ÙØ¶Ù„ 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù)</div>
      <ul class="leaderboard-list" id="leaderboard-list"></ul>
    </div>
  </div>

  <div class="game-shell">
    <div class="game-area">
      <canvas id="game-canvas" width="400" height="400"></canvas>

      <div class="overlay" id="game-over-overlay">
        <div class="overlay-card">
          <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø© ğŸ’¥</h2>
          <p id="game-over-message"></p>
          <p>Ù†ØªÙŠØ¬ØªÙƒ: <span id="final-score">0</span> â€“ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù„Ùƒ: <span id="final-best-score">0</span></p>
          <button class="btn" id="restart-btn">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
      </div>

      <div class="celebration-overlay" id="celebration-overlay">
        <div class="celebration-bubble" id="celebration-text">
          ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!
        </div>
      </div>

      <div id="combo-toast" class="combo-toast">ğŸ”¥ ÙƒÙˆÙ…Ø¨Ùˆ Ã—2 â€” Ø£Ø¯Ø§Ø¡ Ø£Ø³Ø·ÙˆØ±ÙŠ!</div>
    </div>
  </div>

  <div class="controls">
    <div class="buttons-row">
      <button class="btn-small primary" id="pause-btn">Ø¥ÙŠÙ‚Ø§Ù / Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
      <button class="btn-small" id="share-btn">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
      <button class="btn-small" id="change-player-btn">ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ø§Ø¹Ø¨</button>
    </div>
    <div class="dpad-wrapper">
      <div class="dpad">
        <button class="dpad-empty"></button>
        <button id="up-btn">â†‘</button>
        <button class="dpad-empty"></button>

        <button id="left-btn">â†</button>
        <button class="dpad-empty"></button>
        <button id="right-btn">â†’</button>

        <button class="dpad-empty"></button>
        <button id="down-btn">â†“</button>
        <button class="dpad-empty"></button>
      </div>
    </div>
  </div>

  <footer>
    ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ØªÙƒØ±ÙŠÙ…Ù‹Ø§ Ù„Ù„Ù…Ø¨Ø¯Ø¹ <strong>Ù†Ø¨ÙŠÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ø´Ø±ÙŠÙÙŠ</strong>ØŒ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ©ØŒ Ù†Ø¸Ø§Ù… Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ ÙˆØ£ØµÙˆØ§Øª Ù…Ø¶Ù…Ù†Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯.
  </footer>
</div>

<script>
(function() {
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');

  const scoreEl = document.getElementById('score');
  const highScoreEl = document.getElementById('high-score');
  const levelEl = document.getElementById('level');
  const rankTextEl = document.getElementById('rank-text');

  const gameOverOverlay = document.getElementById('game-over-overlay');
  const gameOverMessageEl = document.getElementById('game-over-message');
  const finalScoreEl = document.getElementById('final-score');
  const finalBestScoreEl = document.getElementById('final-best-score');
  const restartBtn = document.getElementById('restart-btn');

  const celebrationOverlay = document.getElementById('celebration-overlay');
  const celebrationTextEl = document.getElementById('celebration-text');
  const comboToast = document.getElementById('combo-toast');

  const pauseBtn = document.getElementById('pause-btn');
  const shareBtn = document.getElementById('share-btn');
  const changePlayerBtn = document.getElementById('change-player-btn');
  const speedSelect = document.getElementById('speed-select');

  const upBtn = document.getElementById('up-btn');
  const downBtn = document.getElementById('down-btn');
  const leftBtn = document.getElementById('left-btn');
  const rightBtn = document.getElementById('right-btn');

  const sndEat = document.getElementById('snd-eat');
  const sndGameOver = document.getElementById('snd-gameover');

  const playerSetup = document.getElementById('player-setup');
  const playerNameInput = document.getElementById('player-name-input');
  const playersListEl = document.getElementById('players-list');
  const playerStartBtn = document.getElementById('player-start-btn');
  const playerGuestBtn = document.getElementById('player-guest-btn');

  const playerNameLabel = document.getElementById('player-name-label');
  const playerBestLabel = document.getElementById('player-best-label');
  const playerGamesLabel = document.getElementById('player-games-label');
  const leaderboardList = document.getElementById('leaderboard-list');

  const GRID_SIZE = 20;
  const COLS = canvas.width / GRID_SIZE;
  const ROWS = canvas.height / GRID_SIZE;

  let baseSpeed = parseInt(speedSelect.value, 10);
  let currentSpeed = baseSpeed;
  let loopId = null;

  let snake = [];
  let direction = 'right';
  let nextDirection = 'right';

  let food = null;
  let score = 0;
  let level = 1;
  let isPaused = false;
  let isGameOver = false;
  let lastEatTime = 0;
  let comboCount = 0;
  let comboTimeoutId = null;
  let justAte = false;
  let legendaryShown = false;

  let currentPlayerName = 'Ø¶ÙŠÙ';
  let players = [];
  let currentPlayerRecord = null;

  const lossMessagesTemplates = [
    "Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù…ØªØ§Ø²Ø© ÙŠØ§ [name] ğŸ’ª Ø§Ø¶ØºØ· Ø¥Ø¹Ø§Ø¯Ø© ÙˆÙˆØ±Ù‘ÙŠÙ†Ø§ Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.",
    "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©â€¦ Ù„ÙƒÙ† Ù…Ùˆ Ù†Ù‡Ø§ÙŠØªÙƒ ğŸ‘Œ Ø¬Ø±Ø¨ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ÙˆØ­Ù‚Ù‘Ù‚ Ø±Ù‚Ù… Ø£Ù‚ÙˆÙ‰!",
    "ÙƒÙ„ Ù„Ø§Ø¹Ø¨ Ù…Ø­ØªØ±Ù Ø®Ø³Ø± Ø¢Ù„Ø§Ù Ø§Ù„Ù…Ø±Ø§Øª Ù‚Ø¨Ù„ Ù…Ø§ ÙŠØµÙŠØ± Ø¨Ø·Ù„â€¦ Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© ğŸ˜„",
    "ÙˆÙ„Ø§ ÙŠÙ‡Ù…Ù‘Ùƒ ÙŠØ§ [name]â€¦ Ø£Ù‡Ù… Ø´ÙŠØ¡ Ø¥Ù†Ùƒ ØªØ­Ø§ÙˆÙ„. Ø§Ø¶ØºØ· Ø¥Ø¹Ø§Ø¯Ø© ÙˆØ®Ù„ÙŠÙ†Ø§ Ù†ÙƒÙ…Ù‘Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ!"
  ];

  function rankForScore(sc) {
    if (sc >= 10000) return "Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø¹Ø´Ø±Ø© Ø¢Ù„Ø§Ù";
    if (sc >= 5000) return "Ù‚Ø§Ù‡Ø± Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª";
    if (sc >= 3000) return "Ø®Ø¨ÙŠØ± Ø§Ù„Ø£ÙØ§Ø¹ÙŠ";
    if (sc >= 1500) return "Ù…Ø­ØªØ±Ù Ù…ØªÙ‚Ø¯Ù‘Ù…";
    if (sc >= 500)  return "Ù„Ø§Ø¹Ø¨ Ù‚ÙˆÙŠ";
    if (sc >= 100)  return "Ù…ØªØ¯Ø±Ù‘Ø¨ Ù†Ø´ÙŠØ·";
    return "Ù…Ø¨ØªØ¯Ø¦";
  }

  function bgColorForLevel(lv) {
    if (lv >= 5) return "#1f1435";
    if (lv === 4) return "#111827";
    if (lv === 3) return "#052e16";
    if (lv === 2) return "#0b1220";
    return "#020617";
  }

  function loadPlayers() {
    try {
      const raw = localStorage.getItem('nSnakePlayers_v4');
      players = raw ? JSON.parse(raw) : [];
    } catch(e) {
      players = [];
    }
  }

  function savePlayers() {
    try {
      localStorage.setItem('nSnakePlayers_v4', JSON.stringify(players));
    } catch(e) {}
  }

  function refreshPlayersDatalist() {
    playersListEl.innerHTML = '';
    players.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      playersListEl.appendChild(opt);
    });
  }

  function findOrCreatePlayer(name) {
    let p = players.find(pl => pl.name === name);
    if (!p) {
      p = {
        name,
        highScore: 0,
        lastScore: 0,
        games: 0,
        lastPlayed: null
      };
      players.push(p);
    }
    return p;
  }

  function updatePlayerUI() {
    if (!currentPlayerRecord) return;
    playerNameLabel.textContent = currentPlayerRecord.name;
    playerBestLabel.textContent = currentPlayerRecord.highScore;
    playerGamesLabel.textContent = currentPlayerRecord.games;
  }

  function updateLeaderboard() {
    const sorted = [...players].sort((a, b) => b.highScore - a.highScore).slice(0, 5);
    leaderboardList.innerHTML = '';
    sorted.forEach((p, idx) => {
      const li = document.createElement('li');
      const leftSpan = document.createElement('span');
      const rightSpan = document.createElement('span');
      leftSpan.innerHTML = '<span class="leaderboard-rank">#' + (idx + 1) + '</span>' + p.name;
      rightSpan.className = 'leaderboard-score';
      rightSpan.textContent = p.highScore;
      li.appendChild(leftSpan);
      li.appendChild(rightSpan);
      leaderboardList.appendChild(li);
    });
  }

  function updateSpeed() {
    baseSpeed = parseInt(speedSelect.value, 10);
    currentSpeed = Math.max(70, baseSpeed - (level - 1) * 8);
    if (!isGameOver && !isPaused) {
      clearInterval(loopId);
      loopId = setInterval(gameLoop, currentSpeed);
    }
  }

  function setLevelByScore() {
    const newLevel = Math.floor(score / 50) + 1;
    if (newLevel !== level) {
      level = newLevel;
      levelEl.textContent = level;
      flashLevelUp();
      updateSpeed();
    }
  }

  function flashLevelUp() {
    const borderEl = canvas.parentElement;
    const oldColor = borderEl.style.borderColor;
    borderEl.style.borderColor = "#f97316";
    setTimeout(() => { borderEl.style.borderColor = "#22c55e"; }, 300);
    playEatSound(); // ØµÙˆØª Ø®ÙÙŠÙ Ø§Ø­ØªÙØ§Ù„
  }

  function generateFood() {
    let valid = false;
    while (!valid) {
      const fx = Math.floor(Math.random() * COLS);
      const fy = Math.floor(Math.random() * ROWS);
      valid = !snake.some(seg => seg.x === fx && seg.y === fy);
      if (valid) food = { x: fx, y: fy };
    }
  }

  function initGame() {
    snake = [
      { x: 5, y: 10 },
      { x: 4, y: 10 },
      { x: 3, y: 10 }
    ];
    direction = 'right';
    nextDirection = 'right';
    score = 0;
    level = 1;
    lastEatTime = 0;
    comboCount = 0;
    justAte = false;
    legendaryShown = false;
    isPaused = false;
    isGameOver = false;
    scoreEl.textContent = '0';
    levelEl.textContent = '1';
    rankTextEl.textContent = 'Ø§Ù„Ù„Ù‚Ø¨: ' + rankForScore(0);
    gameOverOverlay.classList.remove('visible');
    hideCelebration();
    hideComboToast();
    generateFood();
    updateSpeed();
    clearInterval(loopId);
    loopId = setInterval(gameLoop, currentSpeed);
    draw();
  }

  function gameLoop() {
    if (isPaused || isGameOver) return;

    direction = nextDirection;
    const head = { ...snake[0] };

    if (direction === 'up') head.y--;
    else if (direction === 'down') head.y++;
    else if (direction === 'left') head.x--;
    else if (direction === 'right') head.x++;

    const hitWall = head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS;
    if (hitWall) {
      onGameOver();
      return;
    }

    for (let i = 0; i < snake.length; i++) {
      if (head.x === snake[i].x && head.y === snake[i].y) {
        onGameOver();
        return;
      }
    }

    snake.unshift(head);

    if (head.x === food.x && head.y === food.y) {
      justAte = true;
      handleFoodEaten();
    } else {
      snake.pop();
      justAte = false;
    }

    draw();
  }

  function handleFoodEaten() {
    const now = performance.now();
    if (now - lastEatTime < 4000) {
      comboCount++;
      if (comboCount >= 3) {
        showComboToast();
      }
    } else {
      comboCount = 1;
      hideComboToast();
    }
    lastEatTime = now;

    let gained = 10;
    if (comboCount >= 3) gained *= 2;

    score += gained;
    if (score > 10000) score = 10000; // Ø­Ø¯ Ø£Ø³Ø·ÙˆØ±ÙŠ Ø£Ø¹Ù„Ù‰ Ø´ÙŠØ¡
    scoreEl.textContent = score;
    setLevelByScore();
    rankTextEl.textContent = 'Ø§Ù„Ù„Ù‚Ø¨: ' + rankForScore(score);
    generateFood();
    playEatSound();

    if (currentPlayerRecord && score > currentPlayerRecord.highScore) {
      currentPlayerRecord.highScore = score;
      highScoreEl.textContent = score;
      triggerCelebration('highscore');
      speakCongrats();
    } else {
      const globalHigh = players.reduce((max, p) => Math.max(max, p.highScore), 0);
      if (score > globalHigh) highScoreEl.textContent = score;
    }

    if (score >= 50 && score - gained < 50) {
      triggerCelebration('milestone50');
    }

    if (score >= 10000 && !legendaryShown) {
      legendaryShown = true;
      triggerCelebration('legendary');
      speakLegendary();
    }
  }

  function drawBackground() {
    ctx.fillStyle = bgColorForLevel(level);
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = 'rgba(148,163,184,0.12)';
    ctx.lineWidth = 1;
    for (let x = 0; x <= canvas.width; x += GRID_SIZE) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, canvas.height);
      ctx.stroke();
    }
    for (let y = 0; y <= canvas.height; y += GRID_SIZE) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width, y);
      ctx.stroke();
    }
  }

  function drawFood() {
    if (!food) return;
    const cx = food.x * GRID_SIZE + GRID_SIZE / 2;
    const cy = food.y * GRID_SIZE + GRID_SIZE / 2;
    const size = GRID_SIZE * 0.8;
    const h = size * 0.9;

    ctx.save();
    ctx.translate(cx, cy);
    const t = performance.now() / 400;
    const pulse = 1 + 0.08 * Math.sin(t * 2 * Math.PI);
    ctx.scale(pulse, pulse);

    ctx.beginPath();
    ctx.moveTo(0, -h / 2);
    ctx.lineTo(-size / 2, h / 2);
    ctx.lineTo(size / 2, h / 2);
    ctx.closePath();
    ctx.fillStyle = '#facc15';
    ctx.fill();
    ctx.strokeStyle = '#f97316';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = '#7c2d12';
    ctx.beginPath();
    ctx.arc(-size * 0.15, 0, 2, 0, Math.PI * 2);
    ctx.arc(0, h * 0.1, 2, 0, Math.PI * 2);
    ctx.arc(size * 0.12, -h * 0.1, 2, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  function drawSnake() {
    for (let i = snake.length - 1; i >= 0; i--) {
      const seg = snake[i];
      const x = seg.x * GRID_SIZE;
      const y = seg.y * GRID_SIZE;
      const isHead = (i === 0);

      let alpha = 0.9 - (i / (snake.length * 1.5));
      if (alpha < 0.3) alpha = 0.3;

      if (isHead) {
        const baseColor = score >= 50 ? '#eab308' : '#22c55e';
        ctx.fillStyle = baseColor;
        ctx.strokeStyle = '#0f172a';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.roundRect(x + 2, y + 2, GRID_SIZE - 4, GRID_SIZE - 4, 5);
        ctx.fill();
        ctx.stroke();

        const eyeRadius = 2;
        ctx.fillStyle = '#0f172a';

        if (direction === 'right') {
          ctx.beginPath();
          ctx.arc(x + GRID_SIZE - 7, y + 7, eyeRadius, 0, Math.PI * 2);
          ctx.arc(x + GRID_SIZE - 7, y + GRID_SIZE - 7, eyeRadius, 0, Math.PI * 2);
          ctx.fill();
        } else if (direction === 'left') {
          ctx.beginPath();
          ctx.arc(x + 7, y + 7, eyeRadius, 0, Math.PI * 2);
          ctx.arc(x + 7, y + GRID_SIZE - 7, eyeRadius, 0, Math.PI * 2);
          ctx.fill();
        } else if (direction === 'up') {
          ctx.beginPath();
          ctx.arc(x + 7, y + 7, eyeRadius, 0, Math.PI * 2);
          ctx.arc(x + GRID_SIZE - 7, y + 7, eyeRadius, 0, Math.PI * 2);
          ctx.fill();
        } else {
          ctx.beginPath();
          ctx.arc(x + 7, y + GRID_SIZE - 7, eyeRadius, 0, Math.PI * 2);
          ctx.arc(x + GRID_SIZE - 7, y + GRID_SIZE - 7, eyeRadius, 0, Math.PI * 2);
          ctx.fill();
        }

        if (justAte) {
          ctx.fillStyle = '#0f172a';
          ctx.beginPath();
          if (direction === 'right') {
            ctx.fillRect(x + GRID_SIZE - 4, y + 8, 3, GRID_SIZE - 16);
          } else if (direction === 'left') {
            ctx.fillRect(x + 1, y + 8, 3, GRID_SIZE - 16);
          } else if (direction === 'up') {
            ctx.fillRect(x + 8, y + 1, GRID_SIZE - 16, 3);
          } else if (direction === 'down') {
            ctx.fillRect(x + 8, y + GRID_SIZE - 4, GRID_SIZE - 16, 3);
          }
        }
      } else {
        const gradient = ctx.createLinearGradient(x, y, x + GRID_SIZE, y + GRID_SIZE);
        if (score >= 50) {
          gradient.addColorStop(0, 'rgba(147, 51, 234,' + alpha + ')');
          gradient.addColorStop(1, 'rgba(236, 72, 153,' + alpha + ')');
        } else {
          gradient.addColorStop(0, 'rgba(34,197,94,' + alpha + ')');
          gradient.addColorStop(1, 'rgba(16,185,129,' + alpha + ')');
        }
        ctx.fillStyle = gradient;
        ctx.strokeStyle = 'rgba(15,23,42,0.9)';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.roundRect(x + 3, y + 3, GRID_SIZE - 6, GRID_SIZE - 6, 4);
        ctx.fill();
        ctx.stroke();
      }
    }
  }

  function draw() {
    drawBackground();
    drawFood();
    drawSnake();
  }

  function onGameOver() {
    isGameOver = true;
    clearInterval(loopId);
    playGameOverSound();

    const now = new Date().toISOString();
    if (currentPlayerRecord) {
      currentPlayerRecord.lastScore = score;
      currentPlayerRecord.games += 1;
      currentPlayerRecord.lastPlayed = now;
      if (score > currentPlayerRecord.highScore) {
        currentPlayerRecord.highScore = score;
      }
    }

    const globalHigh = players.reduce((max, p) => Math.max(max, p.highScore), 0);
    highScoreEl.textContent = globalHigh;

    savePlayers();
    updatePlayerUI();
    updateLeaderboard();

    finalScoreEl.textContent = score;
    finalBestScoreEl.textContent = currentPlayerRecord ? currentPlayerRecord.highScore : score;

    const template = lossMessagesTemplates[Math.floor(Math.random() * lossMessagesTemplates.length)];
    const msg = template.replace('[name]', currentPlayerName);
    gameOverMessageEl.textContent = msg;
    gameOverOverlay.classList.add('visible');
  }

  function triggerCelebration(type) {
    let text = 'ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!';
    if (type === 'milestone50') {
      text = 'ğŸ”¥ ÙˆØµÙ„Øª Ù„Ù€ 50 Ù†Ù‚Ø·Ø© ÙŠØ§ ' + currentPlayerName + '! Ø§Ø³ØªÙ…Ø±!';
    } else if (type === 'legendary') {
      text = 'ğŸ‰ğŸ¥³ Ù…Ø¨Ø±ÙˆÙˆÙˆÙˆÙƒ ÙŠØ§ ' + currentPlayerName +
             '! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ù„Ø¹Ø¨ØªÙƒ Ø§Ù„Ø®Ø§ØµØ© â€” Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© (10,000 Ù†Ù‚Ø·Ø©)!';
    }
    celebrationTextEl.textContent = text;
    celebrationOverlay.classList.add('visible');
    setTimeout(hideCelebration, 1000);
  }

  function hideCelebration() {
    celebrationOverlay.classList.remove('visible');
  }

  function showComboToast() {
    comboToast.style.display = 'block';
    if (comboTimeoutId) clearTimeout(comboTimeoutId);
    comboTimeoutId = setTimeout(hideComboToast, 900);
  }

  function hideComboToast() {
    comboToast.style.display = 'none';
  }

  function playEatSound() {
    try {
      sndEat.currentTime = 0;
      sndEat.play().catch(() => {});
    } catch(e) {}
  }

  function playGameOverSound() {
    try {
      sndGameOver.currentTime = 0;
      sndGameOver.play().catch(() => {});
    } catch(e) {}
  }

  function speakCongrats() {
    if (!('speechSynthesis' in window)) return;
    const text = 'Ù…Ø¨Ø±ÙˆÙƒ ÙŠØ§ ' + currentPlayerName + 'ØŒ Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!';
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ar-SA';
    utter.rate = 1.02;
    try {
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    } catch(e) {}
  }

  function speakLegendary() {
    if (!('speechSynthesis' in window)) return;
    const text = 'Ù…Ø¨Ø±ÙˆÙˆÙˆÙˆÙƒ ÙŠØ§ ' + currentPlayerName +
      '! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ù„Ø¹Ø¨ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©ØŒ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© Ø¹Ø´Ø±Ø© Ø¢Ù„Ø§Ù Ù†Ù‚Ø·Ø©.';
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ar-SA';
    utter.rate = 1.0;
    try {
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    } catch(e) {}
  }

  document.addEventListener('keydown', function(e) {
    if (playerSetup.style.display !== 'none') return;
    if (e.key === 'ArrowUp' && direction !== 'down') nextDirection = 'up';
    else if (e.key === 'ArrowDown' && direction !== 'up') nextDirection = 'down';
    else if (e.key === 'ArrowLeft' && direction !== 'right') nextDirection = 'left';
    else if (e.key === 'ArrowRight' && direction !== 'left') nextDirection = 'right';
    else if (e.key === ' ' || e.key === 'p' || e.key === 'P') togglePause();
  });

  upBtn.addEventListener('click', () => { if (direction !== 'down') nextDirection = 'up'; });
  downBtn.addEventListener('click', () => { if (direction !== 'up') nextDirection = 'down'; });
  leftBtn.addEventListener('click', () => { if (direction !== 'right') nextDirection = 'left'; });
  rightBtn.addEventListener('click', () => { if (direction !== 'left') nextDirection = 'right'; });

  function togglePause() {
    if (isGameOver) return;
    isPaused = !isPaused;
    pauseBtn.textContent = isPaused ? 'Ø§Ø³ØªØ¦Ù†Ø§Ù' : 'Ø¥ÙŠÙ‚Ø§Ù / Ø§Ø³ØªØ¦Ù†Ø§Ù';
  }

  pauseBtn.addEventListener('click', togglePause);

  restartBtn.addEventListener('click', function() {
    gameOverOverlay.classList.remove('visible');
    initGame();
  });

  speedSelect.addEventListener('change', function() {
    updateSpeed();
  });

  shareBtn.addEventListener('click', function() {
    const text = 'Ø­Ù‚Ù‚Øª Ù†ØªÙŠØ¬Ø© ' + score +
      ' ÙÙŠ Ù„Ø¹Ø¨Ø© N-Snake v4.0 Ø§Ù„Ù…Ù„ÙƒÙŠØ©! Ø¬Ø±Ù‘Ø¨Ù‡Ø§ Ø£Ù†Øª Ø£ÙŠØ¶Ù‹Ø§ ğŸ®ğŸ';
    if (navigator.share) {
      navigator.share({
        title: 'Ù„Ø¹Ø¨Ø© N-Snake',
        text,
        url: window.location.href
      }).catch(() => {});
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(text + ' ' + window.location.href)
        .then(() => alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.'));
    } else {
      alert(text);
    }
  });

  changePlayerBtn.addEventListener('click', function() {
    playerSetup.style.display = 'flex';
  });

  playerStartBtn.addEventListener('click', function() {
    const name = (playerNameInput.value || '').trim();
    if (!name) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨ ÙƒØ¶ÙŠÙ.');
      return;
    }
    startForPlayer(name);
    playerSetup.style.display = 'none';
  });

  playerGuestBtn.addEventListener('click', function() {
    startForPlayer('Ø¶ÙŠÙ');
    playerSetup.style.display = 'none';
  });

  function startForPlayer(name) {
    currentPlayerName = name;
    loadPlayers();
    currentPlayerRecord = findOrCreatePlayer(name);
    savePlayers();
    refreshPlayersDatalist();
    highScoreEl.textContent = currentPlayerRecord.highScore || 0;
    updatePlayerUI();
    updateLeaderboard();
    initGame();
  }

  loadPlayers();
  refreshPlayersDatalist();
  playerSetup.style.display = 'flex';
  draw();
})();
</script>
</body>
</html>
